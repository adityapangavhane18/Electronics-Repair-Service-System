<!DOCTYPE html>
<html>
<head>
  <title>Customer Dashboard</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
    }
    .dashboard-card {
      border-radius: 1rem;
    }
    .progress-bar {
      font-size: 0.8rem;
      white-space: nowrap;
    }
  </style>
</head>
<body class="bg-light">

<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-lg-8 col-md-10">
      <div class="card p-4 shadow dashboard-card">
        <h2 class="mb-4">Welcome, <span class="text-primary">{{ user.username }}</span>!</h2>
        <h4>Your Dashboard <small class="text-muted">(External User)</small></h4>
        <p>Here you can:</p>
        <ul class="list-group list-group-flush mb-3">
          <li class="list-group-item">Submit a new service request</li>
          <li class="list-group-item">View status of past complaints</li>
        </ul>
        <div class="d-flex flex-wrap gap-2">
          <a href="{% url 'logout' %}" class="btn btn-danger">Logout</a>
          <a href="{% url 'submit_request' %}" class="btn btn-primary">Submit New Service Request</a>
          <button class="btn btn-warning" onclick="openStatusModal()">Track Repair Status</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chatbot Widget -->
<div id="chatbot-container" style="position: fixed; bottom: 20px; right: 20px; width: 320px;">
  <div class="card shadow" style="display: none;" id="chatbot-box">
    <div class="card-header bg-primary text-white p-2">
      <strong>Chatbot</strong>
      <button onclick="toggleChatbot()" class="btn-close btn-close-white float-end"></button>
    </div>
    <div class="card-body" id="chatbot-messages" style="height: 220px; overflow-y: auto;">
      <div><strong>Bot:</strong> Hi! How can I help you today?</div>
    </div>
    <div class="card-footer p-2">
      <input type="text" id="chatbot-input" class="form-control" placeholder="Type a message..." onkeypress="handleKeyPress(event)">
    </div>
  </div>
  <button onclick="toggleChatbot()" class="btn btn-primary rounded-circle shadow" style="width: 60px; height: 60px;">ðŸ’¬</button>
</div>

<!-- Status Modal -->
<div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow rounded-4">
      <div class="modal-header bg-warning">
        <h5 class="modal-title" id="statusModalLabel">Track Repair Status</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="text" id="serialInput" class="form-control mb-3" placeholder="Enter Serial Number">
        <div id="statusResult"></div>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  function toggleChatbot() {
    var box = document.getElementById('chatbot-box');
    box.style.display = (box.style.display === 'none') ? 'block' : 'none';
  }

  function handleKeyPress(e) {
    if (e.key === 'Enter') {
      sendMessage();
    }
  }

  function sendMessage() {
    var input = document.getElementById('chatbot-input');
    var msg = input.value.trim();
    if (!msg) return;

    const chatWindow = document.getElementById('chatbot-messages');
    chatWindow.innerHTML += `<div><strong>You:</strong> ${msg}</div>`;
    input.value = '';

    fetch("{% url 'chatbot_response' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({ message: msg })
    })
    .then(response => response.json())
    .then(data => {
      chatWindow.innerHTML += `<div><strong>Bot:</strong> ${data.reply}</div>`;
      chatWindow.scrollTop = chatWindow.scrollHeight;
    });
  }

  function openStatusModal() {
    const modal = new bootstrap.Modal(document.getElementById('statusModal'));
    document.getElementById('serialInput').value = '';
    document.getElementById('statusResult').innerHTML = '';
    modal.show();
  }

  function getStatusIndex(status) {
    const order = ['new', 'validated', 'awaiting_dispatch', 'in_repair', 'repaired', 'dispatched', 'rejected'];
    return order.indexOf(status);
  }

  function fetchStatus() {
    const serial = document.getElementById('serialInput').value.trim();
    if (!serial) {
      alert("Please enter a Serial Number");
      return;
    }

    fetch("{% url 'track_status' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({ serial_number: serial })
    })
    .then(response => response.json())
    .then(data => {
      const resultDiv = document.getElementById('statusResult');
      if (data.success) {
        const stages = ['New', 'Validated', 'Awaiting Dispatch', 'In Repair', 'Repaired', 'Dispatched', 'Rejected'];
        const currentStatus = getStatusIndex(data.status);

        let tracker = `<div class="progress" style="height: 40px;">`;
        stages.forEach((stage, index) => {
          const isActive = index <= currentStatus;
          tracker += `
            <div class="progress-bar ${isActive ? 'bg-success' : 'bg-secondary'}" role="progressbar" 
                 style="width: ${100 / stages.length}%;" 
                 aria-valuenow="${index + 1}" aria-valuemin="0" aria-valuemax="${stages.length}">
              ${stage}
            </div>`;
        });
        tracker += `</div>`;
        resultDiv.innerHTML = tracker;
      } else {
        resultDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
      }
    });
  }

  document.addEventListener('DOMContentLoaded', function () {
    const serialInput = document.getElementById('serialInput');
    if (serialInput) {
      serialInput.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') fetchStatus();
      });
    }
  });
</script>

</body>
</html>
